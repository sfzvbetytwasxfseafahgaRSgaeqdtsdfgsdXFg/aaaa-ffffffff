-- ===== PRIME DHC AUTO FARM - OPTIMIZED VERSION =====
print("[Prime DHC] Starting optimized auto farm...")

if not getgenv().Data or not getgenv().Data.authenticated then
    game:GetService("Players").LocalPlayer:Kick("Run the loader first")
    return
end

-- ===== CONFIGURATION =====
local Config = {
    Combat = {
        MaxAttackTime = 10,
        Prediction = 0.165,
        ReloadThreshold = 3,
        EquipDelay = 0.4,
        ShootInterval = 0.05,
        PostKillDelay = 1.5
    },
    Collection = {
        Range = 50,
        Duration = 5,
        CheckInterval = 0.1
    },
    Movement = {
        BehindOffset = 4,
        SafeHeight = 3,
        TeleportDelay = 0.3
    },
    Performance = {
        TargetCheckInterval = 0.5,
        GuiUpdateInterval = 1,
        ReloadCheckInterval = 0.12,
        MoneyCheckBatch = 20
    }
}

-- ===== SERVICES =====
local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    VirtualUser = game:GetService("VirtualUser"),
    UserInputService = game:GetService("UserInputService"),
    Workspace = workspace,
    HttpService = game:GetService("HttpService"),
    TeleportService = game:GetService("TeleportService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage")
}

local Player = Services.Players.LocalPlayer

-- ===== STATE MANAGER =====
local State = {
    isRunning = false,
    currentTarget = nil,
    isShooting = false,
    isCollecting = false,
    startTime = 0,
    startCash = 0,
    fps = 60,
    lastTargetPos = nil,
    gui = nil,
    blackScreen = nil
}

-- ===== ROBUST COMPATIBILITY LAYER =====
print("[Prime DHC] Loading robust compatibility layer...")

local function createFireClickDetector()
    return function(detector, distance)
        if not detector then return end
        distance = distance or 0

        local success = false

        -- Method 1: Connection firing
        if not success and getconnections then
            success = pcall(function()
                for _, conn in pairs(getconnections(detector.MouseClick)) do
                    if conn.Function then
                        conn:Fire()
                        success = true
                    end
                end
            end)
        end

        -- Method 2: Direct MouseClick:Fire()
        if not success then
            success = pcall(function()
                detector.MouseClick:Fire()
            end)
        end

        -- Method 3: Virtual input
        if not success then
            pcall(function()
                detector:InputBegan(Enum.UserInputType.MouseButton1)
                task.wait(0.01)
                detector:InputEnded(Enum.UserInputType.MouseButton1)
            end)
        end

        -- Method 4: Physical teleport
        if not success then
            pcall(function()
                local char = Player.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    local hrp = char.HumanoidRootPart
                    local oldCFrame = hrp.CFrame
                    hrp.CFrame = CFrame.new(detector.Parent.Position + Vector3.new(0, 3, 0))
                    task.wait(0.03)
                    hrp.CFrame = oldCFrame
                end
            end)
        end
    end
end

local fireclickdetector = getgenv().fireclickdetector or _G.fireclickdetector or createFireClickDetector()
getgenv().fireclickdetector = fireclickdetector
_G.fireclickdetector = fireclickdetector

print("[Prime DHC] Compatibility layer loaded!")

-- ===== SILENT AIM SETUP =====
local SilentAim = {
    target = nil,
    velocity = Vector3.zero
}

if hookmetamethod then
    local oldIndex
    oldIndex = hookmetamethod(game, "__index", newcclosure(function(self, key)
        if self:IsA("Mouse") and SilentAim.target then
            if key == "Hit" then
                local predicted = SilentAim.target.CFrame + (SilentAim.velocity * Config.Combat.Prediction)
                return predicted
            elseif key == "Target" then
                return SilentAim.target
            end
        end
        return oldIndex(self, key)
    end))
else
    warn("[Prime DHC] hookmetamethod not supported, silent aim disabled!")
end

-- ===== FPS TRACKER =====
Services.RunService.Heartbeat:Connect(function(dt)
    State.fps = math.floor(1 / dt)
end)

pcall(function()
    if setfpscap and getgenv().AutofarmSettings then
        setfpscap(getgenv().AutofarmSettings.Main.Fps)
    end
end)

-- ===== UTILITY FUNCTIONS =====
local Utils = {}

function Utils.formatMoney(amount)
    local formatted = tostring(math.floor(amount)):reverse():gsub("(%d%d%d)", "%1,")
    formatted = formatted:reverse():gsub("^,", ""):gsub(",$", "")
    return "$" .. formatted
end

function Utils.randomDelay(min, max)
    min = min or (getgenv().AutofarmSettings and getgenv().AutofarmSettings.Main.Delay or 0.1)
    max = max or min + 0.2
    task.wait(math.random(min * 100, max * 100) / 100)
end

function Utils.isValidCharacter(char)
    return char and char.Parent and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid")
end

function Utils.safeTP(hrp, position)
    if not hrp then return false end
    hrp.CFrame = CFrame.new(position)
    hrp.AssemblyLinearVelocity = Vector3.zero
    hrp.AssemblyAngularVelocity = Vector3.zero
    return true
end

-- ===== WEAPON MANAGER =====
local WeaponManager = {}

function WeaponManager.hasAUG()
    local containers = {Player.Backpack}
    local char = Player.Character
    if char then table.insert(containers, char) end
    
    for _, container in pairs(containers) do
        for _, tool in pairs(container:GetChildren()) do
            if tool:IsA("Tool") and string.lower(tool.Name):find("aug") then
                return true
            end
        end
    end
    return false
end

function WeaponManager.getAUGTool()
    local char = Player.Character
    if not char then return nil end
    
    for _, tool in pairs(char:GetChildren()) do
        if tool:IsA("Tool") and string.lower(tool.Name):find("aug") then
            return tool
        end
    end
    
    for _, tool in pairs(Player.Backpack:GetChildren()) do
        if tool:IsA("Tool") and string.lower(tool.Name):find("aug") then
            return tool
        end
    end
    
    return nil
end

function WeaponManager.equipAUG()
    local char = Player.Character
    if not Utils.isValidCharacter(char) then return false end
    
    local tool = WeaponManager.getAUGTool()
    if not tool then return false end
    
    if tool.Parent ~= char then
        local hum = char.Humanoid
        hum:EquipTool(tool)
        task.wait(Config.Combat.EquipDelay)
    end
    
    return true
end

function WeaponManager.needsReload(tool)
    if not tool then return false end
    local ammo = tool:FindFirstChild("Ammo")
    if ammo and ammo:IsA("IntValue") then
        return ammo.Value <= Config.Combat.ReloadThreshold
    end
    return true
end

function WeaponManager.reload()
    local mainEvent = Services.ReplicatedStorage:FindFirstChild("MainEvent")
    if not mainEvent then return false end
    
    local char = Player.Character
    if not char then return false end
    
    local tool = char:FindFirstChildOfClass("Tool")
    if tool and WeaponManager.needsReload(tool) then
        mainEvent:FireServer("Reload", tool)
        return true
    end
    return false
end

-- ===== SHOP MANAGER =====
local ShopManager = {
    augBuyPos = Vector3.new(-273.0153041799, 52.2666088321, -216.104867764),
    ammoBuyPos = Vector3.new(-277.8882854219, 52.3626088321, -217.0169677738)
}

function ShopManager.findShopItem(pos, isAmmo)
    local shop = Services.Workspace:FindFirstChild("Ignored")
    if not shop then return nil end
    shop = shop:FindFirstChild("Shop")
    if not shop then return nil end
    
    local minDist = math.huge
    local bestCD = nil
    
    for _, item in pairs(shop:GetChildren()) do
        local nameLower = string.lower(item.Name)
        if nameLower:find("aug") and (isAmmo == (nameLower:find("ammo") ~= nil)) then
            local head = item:FindFirstChild("Head")
            local cd = item:FindFirstChild("ClickDetector") or (head and head:FindFirstChild("ClickDetector"))
            if cd and head then
                local dist = (head.Position - pos).Magnitude
                if dist < minDist then
                    minDist = dist
                    bestCD = cd
                end
            end
        end
    end
    
    return bestCD
end

function ShopManager.buyItem(pos, isAmmo)
    local char = Player.Character
    if not Utils.isValidCharacter(char) then return false end
    
    Utils.safeTP(char.HumanoidRootPart, pos)
    task.wait(0.5)
    
    local cd = ShopManager.findShopItem(pos, isAmmo)
    if cd then
        if isAmmo then
            for i = 1, 100 do
                pcall(function() fireclickdetector(cd) end)
                task.wait(0.035)
            end
        else
            pcall(function() fireclickdetector(cd) end)
            task.wait(0.5)
        end
        return true
    end
    
    return false
end

function ShopManager.autoBuy()
    if not WeaponManager.hasAUG() then
        ShopManager.buyItem(ShopManager.augBuyPos, false)
        task.wait(3)
    end
    ShopManager.buyItem(ShopManager.ammoBuyPos, true)
end

-- ===== TARGET MANAGER =====
local TargetManager = {}

function TargetManager.findBestTarget()
    local cashiersFolder = Services.Workspace:FindFirstChild("Cashiers")
    if not cashiersFolder then return nil, nil end
    
    local char = Player.Character
    if not Utils.isValidCharacter(char) then return nil, nil end
    
    local playerPos = char.HumanoidRootPart.Position
    local bestTarget = nil
    local bestOpenPart = nil
    local bestDist = math.huge
    
    for _, cashierModel in pairs(cashiersFolder:GetChildren()) do
        local humanoid = cashierModel:FindFirstChild("Humanoid")
        local openPart = cashierModel:FindFirstChild("Open")
        
        if humanoid and openPart and humanoid.Health > 0 then
            local dist = (openPart.Position - playerPos).Magnitude
            if dist < bestDist then
                bestDist = dist
                bestTarget = cashierModel
                bestOpenPart = openPart
            end
        end
    end
    
    return bestTarget, bestOpenPart
end

-- ===== MONEY COLLECTOR =====
local MoneyCollector = {}

function MoneyCollector.collectNearby(centerPos, radius, duration)
    State.isCollecting = true
    local startTime = tick()
    local collected = 0
    
    while (tick() - startTime) < duration do
        local dropsFolder = Services.Workspace:FindFirstChild("Ignored")
        if not dropsFolder then break end
        
        local dropFolder = dropsFolder:FindFirstChild("Drop")
        if not dropFolder then break end
        
        local batch = 0
        for _, cashPart in pairs(dropFolder:GetChildren()) do
            if cashPart:IsA("Part") and cashPart.Name == "MoneyDrop" then
                local dist = (cashPart.Position - centerPos).Magnitude
                if dist <= radius then
                    MoneyCollector.collect(cashPart)
                    collected = collected + 1
                    batch = batch + 1
                    
                    -- Yield every batch to prevent lag
                    if batch >= Config.Performance.MoneyCheckBatch then
                        task.wait()
                        batch = 0
                    end
                end
            end
        end
        
        task.wait(Config.Collection.CheckInterval)
    end
    
    State.isCollecting = false
    return collected
end

function MoneyCollector.collect(moneyPart)
    if not moneyPart or not moneyPart.Parent then return false end
    
    local cd = moneyPart:FindFirstChild("ClickDetector")
    if not cd then return false end
    
    local char = Player.Character
    if not Utils.isValidCharacter(char) then return false end
    
    local oldCFrame = char.HumanoidRootPart.CFrame
    char.HumanoidRootPart.CFrame = CFrame.new(moneyPart.Position)
    task.wait(0.1)
    
    pcall(function() fireclickdetector(cd) end)
    
    task.wait(0.1)
    char.HumanoidRootPart.CFrame = oldCFrame
    
    return true
end

-- ===== COMBAT MANAGER =====
local CombatManager = {}

function CombatManager.shootTarget(targetModel)
    local char = Player.Character
    if not Utils.isValidCharacter(char) then return false end
    
    local targetHum = targetModel:FindFirstChild("Humanoid")
    local targetRoot = targetModel:FindFirstChild("HumanoidRootPart")
    
    if not targetRoot or not targetHum or targetHum.Health <= 0 then
        return false
    end
    
    -- Enable silent aim
    SilentAim.target = targetRoot
    SilentAim.velocity = targetRoot.Velocity
    
    State.isShooting = true
    local startTime = tick()
    local killed = false
    
    -- Create death detector
    local deathConnection
    deathConnection = targetHum.Died:Connect(function()
        killed = true
        if deathConnection then
            deathConnection:Disconnect()
        end
    end)
    
    -- Shoot loop
    while not killed and (tick() - startTime) < Config.Combat.MaxAttackTime do
        if not targetHum or targetHum.Health <= 0 then
            killed = true
            break
        end
        
        -- Update silent aim velocity
        if targetRoot then
            SilentAim.velocity = targetRoot.Velocity
        end
        
        -- Activate weapon
        local equipped = char:FindFirstChildOfClass("Tool")
        if equipped and string.lower(equipped.Name):find("aug") then
            pcall(function() equipped:Activate() end)
        else
            -- Re-equip if needed
            WeaponManager.equipAUG()
        end
        
        task.wait(Config.Combat.ShootInterval)
    end
    
    -- Cleanup
    if deathConnection then
        deathConnection:Disconnect()
    end
    
    SilentAim.target = nil
    State.isShooting = false
    
    return killed
end

function CombatManager.robTarget(targetModel, openPart)
    if State.currentTarget then return false end
    State.currentTarget = targetModel
    
    local char = Player.Character
    if not Utils.isValidCharacter(char) then
        State.currentTarget = nil
        return false
    end
    
    local hrp = char.HumanoidRootPart
    local targetRoot = targetModel:FindFirstChild("HumanoidRootPart")
    
    if not targetRoot then
        State.currentTarget = nil
        return false
    end
    
    -- Position behind cashier
    local tpPos = openPart.Position - openPart.CFrame.LookVector * Config.Movement.BehindOffset
    Utils.safeTP(hrp, tpPos)
    Utils.randomDelay(Config.Movement.TeleportDelay, 0.5)
    
    -- Equip weapon
    if not WeaponManager.equipAUG() then
        warn("[Prime DHC] Failed to equip weapon, buying...")
        ShopManager.autoBuy()
        State.currentTarget = nil
        return false
    end
    
    -- Attack
    local killed = CombatManager.shootTarget(targetModel)
    
    if killed then
        -- Wait for loot spawn
        task.wait(Config.Combat.PostKillDelay)
        
        -- Move to collection position
        local collectPos = targetRoot.Position
        State.lastTargetPos = collectPos
        Utils.safeTP(hrp, collectPos + Vector3.new(0, Config.Movement.SafeHeight, 0))
        
        -- Collect money
        MoneyCollector.collectNearby(collectPos, Config.Collection.Range, Config.Collection.Duration)
    end
    
    State.currentTarget = nil
    return killed
end

-- ===== GUI MANAGER =====
local GUIManager = {}

function GUIManager.setup()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PrimeFarm"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = Player:WaitForChild("PlayerGui")
    _G.farmGui = screenGui
    
    local blackScreen = Instance.new("Frame")
    blackScreen.Name = "BlackScreen"
    blackScreen.Size = UDim2.new(1, 0, 1, 0)
    blackScreen.BackgroundColor3 = Color3.new(0, 0, 0)
    blackScreen.BorderSizePixel = 0
    blackScreen.ZIndex = 0
    blackScreen.Parent = screenGui
    
    local frame = Instance.new("Frame")
    frame.Name = "MainFrame"
    frame.Size = UDim2.new(0, 320, 0, 280)
    frame.Position = UDim2.new(0.5, -160, 0.5, -140)
    frame.BackgroundColor3 = Color3.fromRGB(15, 23, 42)
    frame.BorderSizePixel = 0
    frame.ZIndex = 10
    frame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = frame
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(0, 255, 255)
    stroke.Thickness = 2
    stroke.Parent = frame
    
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 60)
    header.BackgroundColor3 = Color3.fromRGB(0, 255, 255)
    header.BackgroundTransparency = 0.9
    header.ZIndex = 11
    header.Parent = frame
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 12)
    headerCorner.Parent = header
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, 0, 0, 22)
    title.Position = UDim2.new(0, 0, 0, 12)
    title.BackgroundTransparency = 1
    title.Text = "PRIMES DA HOOD AUTO FARM"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Center
    title.ZIndex = 12
    title.Parent = header
    
    local subtitle = Instance.new("TextLabel")
    subtitle.Name = "Subtitle"
    subtitle.Size = UDim2.new(1, 0, 0, 15)
    subtitle.Position = UDim2.new(0, 0, 0, 37)
    subtitle.BackgroundTransparency = 1
    subtitle.Text = "discord.gg/primedhc"
    subtitle.TextColor3 = Color3.fromRGB(200, 255, 255)
    subtitle.Font = Enum.Font.Gotham
    subtitle.TextSize = 12
    subtitle.TextXAlignment = Enum.TextXAlignment.Center
    subtitle.ZIndex = 12
    subtitle.Parent = header
    
    local statsContainer = Instance.new("Frame")
    statsContainer.Name = "StatsContainer"
    statsContainer.Size = UDim2.new(1, -20, 1, -70)
    statsContainer.Position = UDim2.new(0, 10, 0, 65)
    statsContainer.BackgroundTransparency = 1
    statsContainer.ZIndex = 11
    statsContainer.Parent = frame
    
    local function createStatLabel(yPos, name, initialText)
        local label = Instance.new("TextLabel")
        label.Name = name
        label.Size = UDim2.new(1, 0, 0, 30)
        label.Position = UDim2.new(0, 0, 0, yPos)
        label.BackgroundTransparency = 1
        label.Text = initialText or ""
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.Font = Enum.Font.Gotham
        label.TextSize = 15
        label.TextXAlignment = Enum.TextXAlignment.Center
        label.ZIndex = 11
        label.Parent = statsContainer
        return label
    end
    
    createStatLabel(0, "UserLabel", "User: Loading...")
    createStatLabel(35, "FPSLabel", "FPS: Loading...")
    createStatLabel(70, "TimeLabel", "Time Running: Loading...")
    createStatLabel(105, "StartCashLabel", "Start Cash: Loading...")
    createStatLabel(140, "CurrentCashLabel", "Current Cash: Loading...")
    createStatLabel(175, "ProfitLabel", "Total Profit: Loading...")
    
    State.gui = screenGui
    State.blackScreen = blackScreen
    
    return screenGui, blackScreen
end

function GUIManager.update()
    pcall(function()
        if not State.gui or not State.gui:FindFirstChild("MainFrame") then return end
        local stats = State.gui.MainFrame:FindFirstChild("StatsContainer")
        if not stats then return end
        
        local elapsed = tick() - State.startTime
        local hours = math.floor(elapsed / 3600)
        local minutes = math.floor((elapsed % 3600) / 60)
        local seconds = math.floor(elapsed % 60)
        local timeString = string.format("%02d:%02d:%02d", hours, minutes, seconds)
        
        local currentCash = Player.DataFolder.Currency.Value
        local profit = currentCash - State.startCash
        
        stats.FPSLabel.Text = "FPS: " .. tostring(State.fps)
        stats.FPSLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
        stats.UserLabel.Text = "User: " .. Player.Name
        stats.UserLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
        stats.TimeLabel.Text = "Time Running: " .. timeString
        stats.StartCashLabel.Text = "Start Cash: " .. Utils.formatMoney(State.startCash)
        stats.CurrentCashLabel.Text = "Current Cash: " .. Utils.formatMoney(currentCash)
        
        local profitLabel = stats.ProfitLabel
        profitLabel.Text = "Total Profit: " .. Utils.formatMoney(profit)
        profitLabel.TextColor3 = (profit >= 0) and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 80, 80)
    end)
end

-- ===== OPTIMIZATION MANAGER =====
local OptimizationManager = {}

function OptimizationManager.init()
    local visualClasses = {
        "Decal", "Texture", "ParticleEmitter", "Smoke", "Fire", "Sparkles",
        "Trail", "Beam", "PostEffect", "Sky", "Atmosphere", "SunRaysEffect",
        "Light", "ColorCorrectionEffect"
    }
    
    local function isIgnored(obj)
        local parent = obj.Parent
        while parent do
            local name = parent.Name
            if name == "Map" or name == "CurrentMap" or name == "BULLET_RAYS" or name == "MoneyDrop" then
                return true
            end
            parent = parent.Parent
        end
        return false
    end
    
    -- Remove existing visual clutter
    task.spawn(function()
        task.wait(2)
        pcall(function()
            for _, obj in pairs(Services.Workspace:GetDescendants()) do
                if not isIgnored(obj) then
                    for _, class in ipairs(visualClasses) do
                        if obj:IsA(class) then
                            pcall(function() obj:Destroy() end)
                            break
                        end
                    end
                end
            end
        end)
    end)
    
    -- Optimize rendering
    pcall(function()
        local lighting = game:GetService("Lighting")
        lighting.GlobalShadows = false
        lighting.FogEnd = 100000
        lighting.Brightness = 0.5
        
        if Services.Workspace.Terrain then
            Services.Workspace.Terrain.WaterWaveSize = 0
            Services.Workspace.Terrain.WaterWaveSpeed = 0
            Services.Workspace.Terrain.WaterReflectance = 0
        end
    end)
    
    -- Auto-remove new visual effects
    Services.Workspace.DescendantAdded:Connect(function(obj)
        pcall(function()
            if not isIgnored(obj) then
                for _, class in ipairs(visualClasses) do
                    if obj:IsA(class) then
                        obj:Destroy()
                        return
                    end
                end
                
                if obj:IsA("BasePart") then
                    obj.CastShadow = false
                    obj.Material = Enum.Material.Plastic
                    obj.Reflectance = 0
                end
            end
        end)
    end)
end

-- ===== SAFETY SYSTEMS =====
local SafetyManager = {}

function SafetyManager.init()
    -- Anti-AFK
    Player.Idled:Connect(function()
        Services.VirtualUser:CaptureController()
        Services.VirtualUser:ClickButton2(Vector2.new())
    end)
    
    -- Anti-KO
    task.spawn(function()
        while true do
            pcall(function()
                local char = Player.Character
                if char then
                    local effects = char:FindFirstChild("BodyEffects")
                    if effects then
                        local ko = effects:FindFirstChild("K.O")
                        if ko and ko.Value == true then
                            for _, v in pairs(char:GetChildren()) do
                                if v:IsA("BasePart") then
                                    v:Destroy()
                                end
                            end
                        end
                    end
                end
            end)
            task.wait(0.1)
        end
    end)
    
    -- Auto reload
    task.spawn(function()
        while true do
            pcall(WeaponManager.reload)
            task.wait(Config.Performance.ReloadCheckInterval)
        end
    end)
    
    -- Out of ammo handler
    task.spawn(function()
        while true do
            task.wait(1)
            pcall(function()
                local char = Player.Character
                if not char then return end
                
                local tool = char:FindFirstChildOfClass("Tool")
                if tool and string.lower(tool.Name):find("aug") then
                    local ammo = tool:FindFirstChild("Ammo")
                    local stored = tool:FindFirstChild("StoredAmmo")
                    if ammo and stored and ammo.Value == 0 and stored.Value == 0 then
                        local hum = char:FindFirstChild("Humanoid")
                        if hum then hum.Health = 0 end
                    end
                end
            end)
        end
    end)
    
    -- Character respawn handler
    Player.CharacterAdded:Connect(function(newChar)
        newChar:WaitForChild("Humanoid")
        newChar:WaitForChild("HumanoidRootPart")
        task.wait(2)
        
        ShopManager.autoBuy()
        task.wait(1)
        WeaponManager.equipAUG()
        
        State.startTime = tick()
        State.startCash = Player.DataFolder.Currency.Value
        GUIManager.update()
    end)
    
    -- Black screen toggle
    Services.UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed or not State.blackScreen then return end
        if input.KeyCode == Enum.KeyCode.Comma then
            State.blackScreen.Visible = not State.blackScreen.Visible
        end
    end)
end

-- ===== WEBHOOK MANAGER =====
local WebhookManager = {}

function WebhookManager.send()
    if not getgenv().AutofarmSettings or not getgenv().AutofarmSettings.Webhook.Webhook or 
       getgenv().AutofarmSettings.Webhook.Webhook ==
